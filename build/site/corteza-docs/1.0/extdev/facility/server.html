<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Corteza Server :: Corteza Docs</title>
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Corteza Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="corteza-docs" data-version="1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Corteza technical and user documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../overview/index.html">Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/index.html#product">Product</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/index.html#security">Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/index.html#architecture">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/index.html#core-development">Core development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/index.html#deployment">Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../overview/index.html#customization">Customization</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../user/index.html">User Manual</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../user/index.html#shell">Corteza one</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../user/index.html#messaging">Corteza Messaging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../user/index.html#crm">CRM</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../user/index.html#service-cloud">Service cloud</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../admin/index.html">Admin Manual</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../admin/index.html#admin-panel">Corteza Admin Panel</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../admin/index.html#compose">Corteza Low Code</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../maint/index.html">Management and Maintenance</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../maint/index.html#requirements">Technical Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../maint/index.html#install">Installing Corteza</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../maint/index.html#setup">Setup</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../maint/index.html#backup">Backup and restore</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Extending and Customizing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#getting-started">Getting started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#prerequisite">Prerequisite</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#terminology">Terminology</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#system-overview">Automation System Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#security">Security</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#resource-table">Resources and Events</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#roadmap">Roadmap</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#facility">Automation System Facility</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#development">Extension Development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#testing">Extension Testing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#debugging">Extension Debugging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html#examples">Extension Examples</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../ext/index.html">Extensions</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ext/index.html#about">About</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../ext/index.html#docusign">Docusign</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Corteza technical and user documentation</span>
    <span class="version">v1.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Corteza technical and user documentation</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">v1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Corteza technical and user documentation</a></li>
    <li><a href="server.html">Corteza Server</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/cortezaproject/corteza-docs/edit/feature-antora/modules/ROOT/pages/extdev/facility/server.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Corteza Server</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The second important bit of the automation system is the Corteza server.
On it&#8217;s own, Corredor server is unable to perform any script execution without an explicit invocation (either by the Corteza server or manually via BloomRPC or similar).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_main_responsibilities"><a class="anchor" href="#_main_responsibilities"></a>Main responsibilities</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Load and register automation scripts on the event bus,</p>
</li>
<li>
<p>run scheduler for deferred automation script execution,</p>
</li>
<li>
<p>setup http handler for <strong>sink routes</strong>,</p>
</li>
<li>
<p>setup http handler for <strong>explicit server script invocation</strong>,</p>
</li>
<li>
<p>setup http handler for <strong>automation script listing</strong>,</p>
</li>
<li>
<p>setup http handler for <strong>automation script bundles</strong>,</p>
</li>
<li>
<p>request script execution based on the provided event.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ext-facility-serverEventBus"><a class="anchor" href="#ext-facility-serverEventBus"></a>Event bus</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to implement a powerful and flexible automation system, we have decided to base it around an event bus.
With the help of an event bus, we are able to trivially handle any combination of automation scripts in a unified, robust manner.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Server side event bus and client side event bus <strong>are not</strong> the same, so both should receive equal attention when reading.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="ext-facility-serverTriggerRegistration"><a class="anchor" href="#ext-facility-serverTriggerRegistration"></a>Server script trigger registration</h3>
<div class="paragraph">
<p>Firstly we need to register <strong>implicit</strong>, <strong>deferred</strong>, <strong>sink</strong> and <strong>iterator</strong> server scripts on the event bus, so they can listen and respond to dispatched events.</p>
</div>
<div class="paragraph">
<p>There is a slight difference between iterator automation scripts and other types of automation scripts (excluding explicit scripts) when it comes to their execution.
Iterator scripts are executed for each resource in the matched set, so their handler functions differ.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">If the script is an iterator</dt>
<dd>
<p>When an iterator script is provided, the handler function invokes the automation script <strong>for each</strong> resource in the given set,</p>
</dd>
<dt class="hdlist1">If the script is any other (except explicit scripts)</dt>
<dd>
<p>When any other script is provided (excluding explicit scripts), the handler function is a generic function that executes for the given event on the given resource.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Other than that, the flow is as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>fetch available automation scripts from Corredor server,</p>
</li>
<li>
<p>for each trigger of every valid automation script (excluding explicit scripts):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>prepare a handler function with respect to the above comment,</p>
</li>
<li>
<p>register the trigger with the handler function on the event bus.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_event_handling_and_script_execution"><a class="anchor" href="#_event_handling_and_script_execution"></a>Event handling and script execution</h3>
<div class="paragraph">
<p>Finally we discuss event dispatching, handling and script execution.
Events are dispatched over the event bus either synchronously or asynchronously.
When an event is dispatched, the following happens:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>find all scripts that can be executed for the given event,</p>
</li>
<li>
<p>execute every automation script in the filtered set,</p>
</li>
<li>
<p>if an error is thrown (other then <code>'Aborted'</code>), stop the execution.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ext-facility-serverSchedule"><a class="anchor" href="#ext-facility-serverSchedule"></a>Scheduler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The scheduler system is responsible for deferred automation script execution.
The system ticks every minute, at the minute, and dispatches events via the event bus.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>There is no mechanism in place that would prevent the automation scripts to overlap.
Either simplify/optimize the script or in the case of complex operations, move to batch processing.</p>
</div>
<div class="ulist">
<div class="title">For example:</div>
<ul>
<li>
<p>Script A runs every minute and the execution takes 1.5min,</p>
</li>
<li>
<p>on first tick, script A is executed,</p>
</li>
<li>
<p>on second tick, script A is executed again along side the old instance.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ext-facility-serverSink"><a class="anchor" href="#ext-facility-serverSink"></a>Sink</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The sink system allows us to implement custom endpoints on the Corteza server.
System&#8217;s flow:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>intercept any HTTP request on the <code>/sink</code> endpoint,</p>
</li>
<li>
<p>basic request validation (provided required parameters),</p>
</li>
<li>
<p>validate request against the sink&#8217;s signature,</p>
</li>
<li>
<p>process request based on:</p>
<div class="ulist">
<ul>
<li>
<p><code>Content-Type</code> or any other HTTP header,</p>
</li>
<li>
<p>remote address (IP),</p>
</li>
<li>
<p>request method and path,</p>
</li>
<li>
<p>username and password (HTTP basic auth)</p>
</li>
<li>
<p>GET (query string) parameters</p>
</li>
<li>
<p>POST parameters</p>
</li>
</ul>
</div>
</li>
<li>
<p>dispatch the event via event bus.</p>
</li>
</ol>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
