include::../../variables.adoc[]

= OAuth2 Server

== Supported grant types and protocols:

 - Authorization Code Grant with PKCE extension; for browser apps
 - Client Credentials; for machine-to-machine use
 - Refresh Token

== Tokens

Hashed value of JSON Web Token is kept in credentials store to support token revocation (logout, RFC 7009).

== Preinstalled clients

- {PRODUCT_NAME} Web applications
- {APP_AUTOMATION}
- Sink #TBD#

=== Client features, options, flags:

.Each client can have/be:
- enabled/disabled,
- grant type
- one or more valid authorizing client IP ranges
- one or more key-secret pairs (see below)
- shortlist of roles (see below)
- interfaces (see below)

Client name and description will be provided via label system

=== Client key-secret pairs

Client can have multiple key-secret pairs.

.Each pair can have/be:
- key string (8 random alphanumeric characters prefixed with `k_`)
- secret string
- validity date range

Client name and description will be provided via label system.
Pair values are immutable.
Pairs can be soft-deleted.

Secret is a JWT with encoded preferences (key, random salt, validity date)


=== Role shortlisting

Each client must have explicitly defined list of roles.
When successfully authenticated, intersection of user's and client roles is used to create a subgroup of roles.
This subgroup is then used in security descriptor for that session.

=== Client interfaces

. JSON REST API
. SINK API
. SCIM #when available#
. GraphQL #when available#


== Security (RBAC)

|===
| Operation | Default | Description

3+| `system`

| `auth-client.create`
| Allow role members creation of new OAuth2 clients
| DENY

3+| `system/auth-client:<client-id>`

| `read`
| Can read details of this client
| DENY

| `update`
| Allow role members to
| DENY

| `delete`
| Can delete this client
| DENY

| `authenticate`
| Can authenticate with this client
| DENY

| `role-shortlist.manage`
| Can manage shortlist of roles
| DENY

| `secret.manage`
| Can manage shortlist of roles
| DENY


|===


== Server Libs

.Options
- https://github.com/RichardKnop/go-oauth2-server
- https://github.com/openshift/osin

None of the libs have support for PKCE flow although `go-oauth2-server` has PR waiting.

== Action log

- client created
- client updated
- client deleted
- client enabled
- client disabled
- client role shortlist changed
- client key-secret pair added
- client key-secret pair enabled
- client key-secret pair disabled
- client key-secret pair disabled
